---
title: "Multilevel Analyse (Hierarchische Regression/Mixed-Model) - sample solution"
author: "QN Nguyen"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: cosmo
    highlight: tango
    toc: true
    toc_depth: 2
    toc_float: true
---

# Preliminaries



## Legend

* Vbl = Variable
* UV = unabhängige Variable(n)
* AV = abhängige Variable
* Koef = Koeffizienten
* Reg = Regression
* Whs = Wahrscheinlichkeit
* L1 = Level 1
* L2 = Level 2

```{r setup, include = F}
knitr::opts_chunk$set(fig.width=12, 
                      fig.height=10, 
                      fig.path='Figs/',
                      fig.align = "center",
                      echo=F, 
                      warning=F, 
                      message=F,
                      error=F,
                      eval=T,
                      include=T)

options(xtable.comment = FALSE, scipen = 9999)

# setwd("C:/Users/qynga/Documents/1. Stuttgart/SM/SMI/Uebungen")
# getwd()
```

```{r packages, results='hide', include = F}
pacman::p_load(haven, tidyverse, dplyr, texreg, kableExtra, knitr, labelled, rmarkdown, sjmisc, sjPlot, sjstats, lmtest, lmerTest, lme4, ggeffects, magrittr, glmmTMB, performance, psych)
# If needed, Little's missing completely at random test function
# remotes::install_github("njtierney/naniar")
# devtools::source_url("https://github.com/njtierney/naniar/blob/master/R/mcar-test.R?raw=TRUE")
```


<br>

## Data Prep

**Benutzen Sie den esse03_mod.sav Datensatz. Benutzen Sie als Gruppierungsvariable „Länder“.**

Overview ess Round 5: https://ess-search.nsd.no/en/study/fd0dc7b6-3d5a-42d4-ad46-7a78e44e3963

```{r data prep, echo = T}
# Datensatz importieren
ess <- read_sav("esse03_mod.sav") 

# Subset erstellen
ess <- ess %>%  # ess nur mit den Variablen land, arbeitslos, lebenszufriedenheit
  # Variablen wählen
  select(Länder, stflife, Erwerbsstatus) %>%  
  mutate(Länder = to_label(Länder)) %>% 
  # Variablennamen zuweisen
  rename(land = Länder,
         arbeitslos = Erwerbsstatus,
         lebenszufriedenheit=stflife) %>%
  # Rekodieren
  # mutate(land = factor(land))
  # mutate(spd = ifelse(wahl == 2, 1, 0),
  #        gewerkschaft = ifelse(gewerkschaft == 1, 1, 0),
  #        evangelisch = ifelse(konfession == 1 | konfession == 2, 1, 0),
  #        geschlecht = ifelse(geschlecht == 1, 1,0)) %>% 
  na.omit()
```

<br>

### Inspizieren

*Ersten 5 Fälle*
```{r i1}
head(ess, 10) %>% 
  kbl() %>%
  kable_classic()
```

*Letzten 5 Fälle*
```{r i2}
tail(ess, 10) %>% 
  kbl() %>%
  kable_classic()
```

<br>

### Deskriptive Stats
<br>
```{r i4}
# summary(ess) %>%
#   kbl() %>%
#   kable_classic()
```

```{r i5}
# library(psych)
describe(ess) %>% 
  kbl() %>%
  kable_classic()
```

**Wie viele Fälle in wie vielen Gruppen?**
```{r}
# unique(ess$land)
# occurences per group (27 groups)
table(ess$land) %>% 
  kbl() %>%
  kable_classic()
```

<br>

**Wie viel % der Befragten sind arbeitslos?**
```{r i3, echo=T}
sum(ess$arbeitslos)/describe(ess$arbeitslos)$n 
```
...ca. 8,6%.

<br>

# Aufgabe 1
**Berechnen Sie das Nullmodell (Modell0) für die AV: stflife (allgemeine Lebenszufriedenheit).**
<br>

## Intercepts-only model
<br>

L1: 

$${Y_{ij}} = {\beta_{0j}} + {e_{ij}}$$
<br>
L2:

$${\beta_{0j}} = {\gamma_{00}} + {u_{0j}}$$
<br>
L1 & L2:

$${Y_{ij}} = {\gamma_{00}} + {u_{0j}} + {e_{ij}}$$

<br>

## Model 0

```{r, echo=T}
m0 <- lmer(lebenszufriedenheit ~ 1 + (1 | land),
           data = ess)
# library(nlme)
# m2a <- lme(lebenszufriedenheit ~ 1, random=~ 1 | land, 
#            data = ess)
```
<br>


```{r}
summary(m0) # includes p-values for fixed effects; reports both std.dev and var for random effects
```

### Koeffizienten der 26 Länder
```{r}
coef(m0)$land %>% 
  kbl() %>%
  kable_classic()
```


### Zusammenfassung
```{r, results='asis'}
# screenreg(m0, float.pos = "!h")
htmlreg(list(m0),
        custom.model.names = c("M0"),  #Labels für Modelle
        custom.coef.names = c("Interzept"), #Labels für Koeffienten (fixed effects)
        custom.gof.names = c("AIC",         #Labels für Fit Statistik & random effects
                             "BIC",                
                             "Log Likelihood",
                             "Observationen",
                             "Laender",
                             "Between-group Var: Intercept",
                             "Within-group Var: Residual"),
        caption = "Abhängige Variable: Lebenszufriedenheit",
        caption.above = T)
```
**Anmerkung: n=26 Länder wurden hier angezeigt, da Portugal keine Fälle eingebracht hatte. 
<br>

## Aufgabe 1a
**Berechnen Sie den ICC anhand des Nullmodells.**

--> L2 (between) und L1 (within) Varianzen in die Formel einsetzen:
$$ICC = \frac{Varianz_{L2}}{Varianz_{L2}+Varianz_{L1}} = \frac{1.02}{1.02+4.12} = \frac{1.02}{5.14} = 0.198$$
<br>

Abgleich mit Software-Lösung:
```{r, echo=T}
icc(m0)
```
..scheint zu passen.

<br>

## Aufgabe 1b

**Welche Aussage lässt sich auf Grundlage des Nullmodells treffen?**

<br> 

Mit einem ICC von 0.198 lassen sich ca. 20% der Gesamtvarianz von Lebenszufriedenheitist auf der Länderebene verorten). Dies ist ein Ausmaß an L2-Varianz, das nach einer MLA fordert (idR schon ab einem ICC von 0.1).

<br>

#### **Visualisierung: random intercept**
Streuung der **random intercepts (means)** der 27 Länder um ihren grand mean (standardisierte Werte):
```{r, echo=T}
# library(sjPlot)
plot_model(m0, 
           type = "re", 
           sort.est = T, 
           show.values = T, 
           show.p = T,
           value.offset = 0.3)
```
**Anmerkung: n=26 Länder wurden hier angezeigt, da Portugal keine Fälle eingebracht hatte. 

Interpretationsbeispiel: Der intercept für die Ukraine ist -1.78 unter dem grand intercept mit dem Wert 6.77, d.h. 6.77-1.78 = 5
<br>


# Aufgabe 2
**Berechnen Sie Modell1 mit der UV: Erwerbsstatus (0=erwerbstätig; 1=arbeitslos).**

<br>

## Random intercept & fixed slope

<br>

L1:

$${Y_{ij}} = {\beta_{0j}} + {\beta_{1}}{X_{1ij}} + {e_{ij}}$$
<br>
L2:

$${\beta_{0j}} = {\gamma_{00}} + {u_{0j}}$$
<br>
L1 & L2:

$${Y_{ij}} = {\gamma_{00}} + {u_{0j}} + {\beta_{1}}{X_{1ij}} + {e_{ij}}$$

<br>

## Model 1
```{r, echo=T}
m1 <- lmer(lebenszufriedenheit ~ 1 + arbeitslos + (1 | land), 
           data = ess)

```
<br>

```{r}
summary(m1) # includes p-values for fixed effects; reports both std.dev and var for random effects
```

### Koeffizienten der 26 Länder
```{r}
coef(m1)$land %>% 
  kbl() %>%
  kable_classic()
```

### Zusammenfassung
```{r, results='asis'}
# screenreg(list(m0, m1))
htmlreg(list(m0, m1),
        custom.model.names = c("M0","M1"),  #Labels für Modelle
        custom.coef.names = c("Interzept","Arbeitslosigkeit"), #Labels für Koeffienten (fixed effects)
        custom.gof.names = c("AIC",                    #Labels für fit Statistik & random effects
                             "BIC",                
                             "Log Likelihood",
                             "Observationen",
                             "Laender",
                             "Between-group Var: Intercept",
                             "Within-group Var: Residual"),
        caption = "Abhängige Variable: Lebenszufriedenheit",
        caption.above = T)


```
**Anmerkung: n=26 Länder wurden hier angezeigt, da Portugal keine Fälle eingebracht hatte. 
<br>

## Aufgabe 2a
**Interpretieren Sie den Koeffizienten für Erwerbsstatus inhaltlich (als Fixed-Effekt).**

Aus Tabachnik/Fidell 2018, S. 633: **fixed effects**

$\gamma_{00}$ (aka $\beta_{0}$) = grand mean when predictor is 0 (average intercept over all groups)= 6.88255
<br>
$\gamma_{10}$ (aka $\beta_{1}$) = grand slope (average slope over all groups) = -1.34111

Der Parameter $\gamma_{10}$ beschreibt den ungewichteten Durchschnitt aller slopes $\beta_{ij}$ der UV arbeitslos über die 27 Länder hinweg. Die Lebenszufriedenheit ist in den 27 europäischen Ländern um durchschnittlich 1,34 Einheiten (auf einer 10-er Skala) niedriger für Arbeitslose als für Erwerbstätige. Dieser Effekt ist mit SE = 0.05 Einheiten signifikant auf dem 0.001 Niveau.



<br>

## Aufgabe 2b
**Führen Sie einen Likelihood-Ratio-Test (LRT) zwischen Modell0 und Modell1 durch (Achten Sie drauf, dass für den LRT die ML-Schätzung und nicht die REML gewählt werden muss).**

Likelihood‐Ratio‐Test (LRT) M0 vs M1:

testet ob das komplexere ML-Modell M1 (4 Parameter) einen signifikant besseren Fit hat als das einfachere nested ML-Modell M0 (3 Parameter).

G-Statistik für LRT ($\chi^2$-verteilt):
$$
\begin{aligned}
G
&= {-2ln\biggl\lbrack \frac{L_0}{L_p}\biggr\rbrack} \\
&= {-2 (LL_0 -LL_p)} \\
&= {(-2LL_0)-(-2LL_p)} \\
&= Devianz_{M_0} - Devianz_{M_1}\\
&= (-2*-43333.75) - (-2*-42996.16) \\
&= 86666 - 85987 \\
&= 679 \\
\end{aligned}
$$

Vergleich mit software-generiertem Wert: 

```{r, echo=T}
anova(m1, m0)
# lrtest(m0, m1)
```
Scheint zu passen: $\chi^2$ = 679.39, p < 0.001

<br>

## Aufgabe 2c
**Wie lautet Ihre Schlussfolgerung für Modell1?**

Mit einer G-Statistik von 679 bei df=1 können wir schlussfolgern, dass das komplexere Modell M1 (mit UV arbeitslos) eine signifikant (p = 0.001) bessere Passung an die emprischen Daten hat als das einfachere Nullmodell (nur intercept).

<br>

# Aufgabe 3
**Lassen Sie in Modell2 (zusätzlich) den Slope von Erwerbsstatus über die Länder variieren (Random setzen).**

<br>

## Random intercept & random slope:
<br>

L1:
$${Y_{ij}} = {\beta_{0j}} + {\beta_{1j}}{X_{1ij}} + {e_{ij}}$$
L2:
$$\begin{aligned}
&{\beta_{0j}} = {\gamma_{00}} + {u_{0j}} \\
&{\beta_{1j}} = {\gamma_{10}} + {u_{1j}}
\end{aligned}$$

L1 & L2:
$$\begin{aligned}
{Y_{ij}}
&= {\gamma_{00}} + {u_{0j}} + ({\gamma_{10}} + {u_{1j}}){X_{1ij}} + {e_{ij}}\\
&= {\gamma_{00}} + {u_{0j}} + {\gamma_{10}}{X_{1ij}} + {u_{1j}}{X_{1ij}} + {e_{ij}}
\end{aligned}$$

<br>

## Model 2
```{r, echo=T}
m2 <- lmer(lebenszufriedenheit ~ 1 + arbeitslos + (1 + arbeitslos | land), 
           data = ess)
# library(nlme)
# m2a <- lme(lebenszufriedenheit ~ arbeitslos, random=~ 1 + arbeitslos | land, 
#            data = ess)

```

```{r}
summary(m2) # includes p-values for fixed effects; reports both std.dev and var for random effects
screenreg(m2, float.pos = "!h")
```

### Koeffizienten der 26 Länder
```{r}
coef(m2)$land %>% 
  kbl() %>%
  kable_classic()
```

<br>

## Aufgabe 3a

**Führen Sie einen Likelihood-Ratio-Test zwischen Modell1 und Modell2 durch.**

Likelihood‐Ratio‐Test (LRT) M1 vs M2: 

testet ob das komplexeres ML-Modell M2 (6 Parameter) einen signifikant besseren Fit hat als das einfachere nested ML-Modell M1 (4 Parameter):

G-Statistik für LRT M2 vs M1 ($\chi^2$-verteilt):
$$
\begin{aligned}
G
&= {-2ln\biggl\lbrack \frac{L_0}{L_p}\biggr\rbrack} \\
&= {-2 (LL_0 -LL_p)} \\
&= {(-2LL_0)-(-2LL_p)} \\
&= Devianz_{M_1} - Devianz_{M_2}\\
&= (-2*-42996.16) - (-2*-42974.38) \\
&= 85992.32 - 85948.76 \\
&= 43.56 \\
\end{aligned}
$$
Vergleich mit software-generiertem Wert: 

```{r, echo=T}
anova(m2, m1)
# lrtest(m1, m2)
```
Scheint zu passen: $\chi^2$ = 42.075, p < 0.001 (auch wenn der Wert leicht abweicht von der handkalkulierten)

Mit einer G-Statistik von ca. 42-43 bei df=2 können wir schlussfolgern, dass das komplexere Modell M2 (random intercepts und random slopes) eine signifikant (p = 0.001) bessere Passung an die emprischen Daten hat als das einfachere Modell M1 (random intercept und fixed slope).

<br>

## Aufgabe 3b

**Interpretieren Sie den Random Slope von Erwerbsstatus inhaltlich (als Random-Effekt)**

<br>

### Zusammenfassung


```{r, results='asis'}
# screenreg(list(m0, m1, m2))
htmlreg(list(m0, m1, m2), 
        custom.model.names = c("M0","M1","M2"),  #Labels für Modelle
        custom.coef.names = c("Interzept","Arbeitslosigkeit"), #Labels für Koeffienten (fixed effects)
        custom.gof.names = c("AIC",                    #Labels für Fit Statistik & random effects
                             "BIC",                
                             "Log Likelihood",
                             "Observationen",
                             "Laender",
                             "Between-group Var: Intercept",
                             "Within-group Var: Residual",
                             "Between-group Var: Slope Arbeitslosigkeit", 
                             "Between-group Covar: Intercept-Slope Arbeitslosigkeit"),
        caption = "Abhängige Variable: Lebenszufriedenheit",
        caption.above = T)

```
**Anmerkung: n=26 Länder wurden hier angezeigt, da Portugal keine Fälle eingebracht hatte. 

<br>

Aus Tabachnik/Fidell 2018, S. 633: 

**random effects:**

*$e_{ij}$ = Variance among observations within groups around their own group mean (within group variance), when the predictor is taken into account (Residual) --> 3.9695

*$\tau_{00}$ = Variance in group means around grand mean (between group variance), when the predictor is taken into account --> 0.9334

*$\tau_{11}$ = Variance in group slopes for a predictor around grand slope (between group variance) --> 0.2201

*$\tau_{10}$ = Covariance between intercepts and slopes (UV-DV Zusammenhang) for groups --> -0.11

**fixed effects:**

*$\gamma_{00}$ (aka $\beta_{0}$) = grand mean when predictor is 0 (average intercept over all groups) = 6.8817

*$\gamma_{10}$ (aka $\beta_{1}$) = grand slope (average slope over all groups) = -1.3163

<br>

Der Parameter $\tau_{11}$ beschreibt die Varianz der slopes für die UV zwischen allen Gruppen um den ihren gemeinsamen durchschnittlichen "grand slope" $\gamma_{10}$. 

Der Einfluss von Arbeitslosigkeit (0 = erwerbstätig, 1 = arbeitslos) auf Lebenszufriedenheit (11-Punkte-Skala) unterscheidet sich signifikant über die untersuchten Länder hinweg (Verbesserung des Gesamtmodell-Fits bei Aufnahme Random Slope, chisq = 42 mit p < 0.001). Der durchschnittliche Einfluss von Arbeitslosigkeit auf Lebenszufriedenheit über alle untersuchten Länder beträgt dabei -1,32 Skalenpunkte, mit 95% der statistisch angenommenen Einkommenskoeffizienten im Bereich zwischen -2.24 und -0.4 Skalenpunkte Lebenszufriedenheit.

Da der Effekt von der L1-UV Arbeitlosigkeit auf die AV Lebenszufriedenheit zwischen den Ländern signifikant variiert, könnte es sich lohnen, UVs auf dem L2 mit in das Modell aufzunehmen, um diese Varianz der Effektstärken zwischen den Ländern zu erklären.

Zuletzt sollte noch angemerkt werden, dass die "Stichprobe" der Aggregateinheiten, d.h. die Länderanzahl, min. 30 betragen sollte für eine "saubere" Schätzung in der MLA. Rein formell haben wir nur 26 Länder (Portugal nicht mitgezählt). Außerdem haben wir noch gar keine Diagnostik durchgeführt, also Probleme mit den Modellannahmen könnten evtl noch auftauchen.
<br>

#### Slopes sortiert nach Größe
```{r}
sort(coef(m2)$land$arbeitslos)
```

#### **Visualisierung: random intercept & random slope**
Streuung der 27 **random intercepts (means)** um den grand mean sowie der 27 **random slopes (effects)** um den grand slope für UV arbeitslos (standardisierte Werte):
```{r, echo=T}
# library(sjPlot)
plot_model(m2, 
           type = "re", 
           sort.est = T, 
           show.values = T, 
           show.p = T,
           value.offset = 0.3)
```
**Anmerkung: 26 Länder wurden hier angezeigt, da Portugal keine Fälle eingebracht hatte. 

Interpretationsbeispiel:
* Der slope arbeitslos für die Ukraine ist 1.2 über dem grand slope mit dem Wert -1.316, d.h. -1.316 + 1.2 = -0.116
* Der intercept für die Ukraine ist -1.88 unter dem grand intercept mit dem Wert 6.88, d.h. 6.88-1.88 = 5
<br>



